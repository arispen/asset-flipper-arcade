<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/dark.min.css">
    <style>
        body {
            max-width: 1400px;
        }
        #layout {
            /* display: flex; */
            width: 100%;
        }
        #inspector {
            padding: 20px;
            width: 500px;
        }
        input {
            width: 100%;
        }
        h2 {
            font-size: 15px;
        }
    </style>
</head>

<body>
    <div id="layout">
        <h1 id="js-game-title"></h1>
        <h2>game created using Asset Flipper Arcade</h2>
        <div id="game-container"></div>
        <div id="inspector">
            <h3>(Refresh page to restart the game)</h3>
            <h3>Modify this game here:</h3>
            <span>Game Title:</span><input id="title" type="text"/>
            <span>Background Image:</span><input id="bgImage" type="text"/>
            <span>Player Image:</span><input id="playerImage" type="text" />
            <span>Enemy Image:</span><input id="enemyImage" type="text" />
            <span>Point Image:</span><input id="pointImage" type="text" />
            <span>Player Speed: </span><input id="playerSpeed" type="number" />
            <span>Player Width:</span><input id="playerWidth" type="number" />
            <span>Player Height:</span><input id="playerHeight" type="number" />
            <span>Point Width:</span><input id="pointWidth" type="number" />
            <span>Point Height:</span><input id="pointHeight" type="number" />
            <span>Enemy Width:</span><input id="enemyWidth" type="number" />
            <span>Enemy Height:</span><input id="enemyHeight" type="number" />
            <br>
            <button id="build" onclick="build()">Rebuild!</button>
        </div>
        <footer>Asset Flipper Arcade v.1.1.0, 2020, Arispen</footer>
    </div>


    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const bgImageInput = document.getElementById("bgImage");
        const playerImageInput = document.getElementById("playerImage");
        const enemyImageInput = document.getElementById("enemyImage");
        const pointImageInput = document.getElementById("pointImage");
        const playerSpeedInput = document.getElementById("playerSpeed");
        const config = {
            playerSize: 70,
            pointSize: 40,
            enemySize: 50,
            playerSpeed:  urlParams.get("playerSpeed") || 600,
            pointSpawnInterval: 2500,
            addEnemyInterval: 20000,
            respawnEnemiesInterval: 500,
            type: Phaser.AUTO,
            parent: "game-container",
            width: 960,
            height: 640,
            physics: {
                default: "arcade",
                arcade: {
                    gravity: { y: 300 },
                    debug: false,
                },
            },
            scene: {
                preload,
                create,
                update,
            },
        };

        const game = new Phaser.Game(config);
        let gameScene;
        let cursors;
        let player;
        let point;
        let enemies;
        let gameOver;
        let score = 0;
        let scoreText;

        function preload() {
            const backgroundImage = urlParams.get("bgImage") || "https://i.ibb.co/pLsmfxn/airadventurelevel4.png";
            const playerImage = urlParams.get("playerImage") || "https://i.ibb.co/10bV3sr/viking.png";
            const pointImage = urlParams.get("pointImage") || "https://i.ibb.co/qCxx0Bw/Mug-of-Beer.png";
            const enemyImage = urlParams.get("enemyImage") || "https://i.ibb.co/0nDF55T/spike.png";
            this.load.image("bg", backgroundImage);
            this.load.image("player", playerImage);
            this.load.image("point", pointImage);
            this.load.image("enemy", enemyImage);
            renderParamsInInspector();
        }

        function renderParamsInInspector() {
            bgImageInput.value = urlParams.get("bgImage") || "https://i.ibb.co/pLsmfxn/airadventurelevel4.png";
            playerImageInput.value = urlParams.get("playerImage") || "https://i.ibb.co/10bV3sr/viking.png";
            pointImageInput.value = urlParams.get("pointImage") || "https://i.ibb.co/qCxx0Bw/Mug-of-Beer.png";
            enemyImageInput.value = urlParams.get("enemyImage") || "https://i.ibb.co/0nDF55T/spike.png";

            // TODO: handle default values
            playerSpeedInput.value = urlParams.get("playerSpeed") || 600;
        }

        function create() {
            gameScene = this;
            cursors = this.input.keyboard.createCursorKeys();

            const bgImage = this.add.image(
                config.width / 2,
                config.height / 2,
                "bg"
            );
            bgImage.displayWidth = config.width;
            bgImage.displayHeight = config.height;

            player = this.physics.add.sprite(
                config.width / 2,
                config.height - 50,
                "player"
            );
            player.displayWidth = config.playerSize;
            player.displayHeight = config.playerSize;
            player.setCollideWorldBounds(true);

            enemies = this.physics.add.group();

            point = this.physics.add.sprite(100, 1000, "point");
            point.displayWidth = config.pointSize;
            point.displayHeight = config.pointSize;

            this.time.addEvent({
                delay: config.pointSpawnInterval,
                loop: true,
                callback: spawnPoint,
                callbackScope: this,
            });

            this.time.addEvent({
                delay: config.addEnemyInterval,
                loop: true,
                callback: addEnemy,
                callbackScope: this,
            });

            this.time.addEvent({
                delay: config.respawnEnemiesInterval,
                loop: true,
                callback: respawnEnemies,
                callbackScope: this,
            });

            this.physics.add.collider(player, enemies, hitEnemy, null, this);
            this.physics.add.overlap(player, point, scorePoint, null, this);

            scoreText = this.add.text(16, 16, "0", {
                fontSize: "32px",
                fill: "#fff",
            });
        }

        function update(time, delta) {
            if (gameOver) {
                return;
            }

            if (cursors.left.isDown) {
                player.setVelocityX(-config.playerSpeed);
            } else if (cursors.right.isDown) {
                player.setVelocityX(+config.playerSpeed);
            } else {
                player.setVelocityX(0);
            }
        }

        function spawnPoint() {
            point.setY(-100);
            point.setX(Phaser.Math.RND.between(0, config.width));
            point.setVelocityY(0);
        }

        function hitEnemy() {
            this.physics.pause();
            player.setTint(0xff0000);
            gameOver = true;
        }

        function scorePoint() {
            score += 1;
            scoreText.setText(score);
            point.setY(1000);
        }

        function respawnEnemies() {
            enemies.children.iterate(function (child) {
                if (child.y > config.height) {
                    child.setY(
                        Phaser.Math.RND.between(-config.enemySize, -config.enemySize * 10)
                    );
                    child.setX(Phaser.Math.RND.between(0, config.width));
                    child.setVelocityY(0);
                }
            });
        }

        function addEnemy() {
            const enemy = enemies.create(
                Phaser.Math.RND.between(0, config.width),
                -100,
                "enemy"
            );
            enemy.displayWidth = config.enemySize;
            enemy.displayHeight = config.enemySize;
            enemy.setVelocityY(0);
        }

        function build() {
            window.location = `/?bgImage=${bgImageInput.value}` + 
            `&playerImage=${playerImageInput.value}&enemyImage=${enemyImageInput.value}&pointImage=${pointImageInput.value}` +
            `&playerSpeed=${playerSpeedInput.value}` ;
        }
    </script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-M1DQS2Q245"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-M1DQS2Q245');
    </script>
</body>

</html>
